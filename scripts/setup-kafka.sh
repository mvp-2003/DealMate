#!/bin/bash

echo "üöÄ Setting up Apache Kafka for DealMate..."

# Create Kafka topics for DealMate
echo "üìã Creating Kafka topics..."

# Wait for Kafka to be ready
echo "‚è≥ Waiting for Kafka to be ready..."
until docker exec dealmate-kafka-1 kafka-topics --bootstrap-server localhost:9092 --list > /dev/null 2>&1; do
    echo "   Kafka not ready, waiting..."
    sleep 5
done

echo "‚úÖ Kafka is ready! Creating topics..."

# Create main topics
docker exec dealmate-kafka-1 kafka-topics --create \
    --bootstrap-server localhost:9092 \
    --topic dealmate.deals \
    --partitions 6 \
    --replication-factor 1 \
    --config retention.ms=604800000 \
    --config compression.type=lz4

docker exec dealmate-kafka-1 kafka-topics --create \
    --bootstrap-server localhost:9092 \
    --topic dealmate.prices \
    --partitions 6 \
    --replication-factor 1 \
    --config retention.ms=2592000000 \
    --config compression.type=lz4

docker exec dealmate-kafka-1 kafka-topics --create \
    --bootstrap-server localhost:9092 \
    --topic dealmate.user.events \
    --partitions 8 \
    --replication-factor 1 \
    --config retention.ms=1209600000 \
    --config compression.type=lz4

docker exec dealmate-kafka-1 kafka-topics --create \
    --bootstrap-server localhost:9092 \
    --topic dealmate.notifications \
    --partitions 4 \
    --replication-factor 1 \
    --config retention.ms=259200000 \
    --config compression.type=lz4

docker exec dealmate-kafka-1 kafka-topics --create \
    --bootstrap-server localhost:9092 \
    --topic dealmate.inventory \
    --partitions 4 \
    --replication-factor 1 \
    --config retention.ms=604800000 \
    --config compression.type=lz4

docker exec dealmate-kafka-1 kafka-topics --create \
    --bootstrap-server localhost:9092 \
    --topic dealmate.analytics \
    --partitions 3 \
    --replication-factor 1 \
    --config retention.ms=2592000000 \
    --config compression.type=lz4

# Create enriched topics for processed data
docker exec dealmate-kafka-1 kafka-topics --create \
    --bootstrap-server localhost:9092 \
    --topic dealmate.enriched.deals \
    --partitions 6 \
    --replication-factor 1 \
    --config retention.ms=604800000 \
    --config compression.type=lz4

docker exec dealmate-kafka-1 kafka-topics --create \
    --bootstrap-server localhost:9092 \
    --topic dealmate.price.trends \
    --partitions 4 \
    --replication-factor 1 \
    --config retention.ms=2592000000 \
    --config compression.type=lz4

# Create dead letter topics for error handling
docker exec dealmate-kafka-1 kafka-topics --create \
    --bootstrap-server localhost:9092 \
    --topic dealmate.deals.dlq \
    --partitions 2 \
    --replication-factor 1 \
    --config retention.ms=604800000

docker exec dealmate-kafka-1 kafka-topics --create \
    --bootstrap-server localhost:9092 \
    --topic dealmate.prices.dlq \
    --partitions 2 \
    --replication-factor 1 \
    --config retention.ms=604800000

echo ""
echo "üìä Created topics:"
docker exec dealmate-kafka-1 kafka-topics --bootstrap-server localhost:9092 --list | grep dealmate

echo ""
echo "‚úÖ Kafka setup completed!"
echo "üåê Kafka UI: http://localhost:8080"
echo "üîß Schema Registry: http://localhost:8081"
echo "üîå Kafka Connect: http://localhost:8083"
echo ""
echo "üìã Topic retention policies:"
echo "   ‚Ä¢ dealmate.deals: 7 days"
echo "   ‚Ä¢ dealmate.prices: 30 days"
echo "   ‚Ä¢ dealmate.user.events: 14 days"
echo "   ‚Ä¢ dealmate.notifications: 3 days"
echo "   ‚Ä¢ dealmate.inventory: 7 days"
echo "   ‚Ä¢ dealmate.analytics: 30 days"
